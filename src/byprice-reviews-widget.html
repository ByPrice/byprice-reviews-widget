<!--
@license
Copyright (c) 2017 ByPrice All rights reserved.
-->

<!-- Third party components -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<!-- End - Third party components -->

<!-- Our Components -->
<link rel="import" href="./byprice-rating-star.html">
<link rel="import" href="./byprice-write-a-review.html">
<link rel="import" href="./byprice-review-message.html">
<link rel="import" href="./byprice-reviews-widget-styles.html">
<link rel="import" href="./byprice-reviews-sign-preview.html">
<!-- End - Our Components -->

<dom-module id="byprice-reviews-widget">
  <template>
    <style include="byprice-reviews-widget-styles">
      :host {
        max-width: 550px;
        display: block;
      }

      header {
        font-size: 22px;
      }

      .wrapper {
        background: transparent
      }

      .summary-rating-stars {
        margin: 0 0 0 10px;
      }

      .view-all {
        margin: 20px 0;
        text-align: center;
        color: #960062;
      }

      .view-all span {
        cursor: pointer;
      }

      .forms-wrapper {
        position: relative;
        background: transparent;
        background: #f0f0f0;
        padding: 15px 20px;
        border: 1px solid #dadada;
        border-radius: 5px;
      }

      .loader {
        position: absolute;
        width: 100%;
        height: 2px;
        top: 0;
        left: 0;
        animation: move 3s linear infinite alternate;
        -webkit-animation: move 3s linear infinite alternate;
        z-index: 1;
      }

      .loader::before {
        content: "";
        width: 80px;
        height: 2px;
        position: absolute;
        top: 0;
        left: 0;
        background: #0084FF;
      }

      .loader-over {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: rgba(255, 255, 255, .8);
        z-index: 1;
      }

      @-webkit-keyframes move {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(calc(100% - 80px));
        }
      }

      @keyframes move {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(calc(100% - 80px));
        }
      }


      .preview {
        opacity: 0;
        -ms-transform: translateY(30px);
        -webkit-transform: translateY(30px);
        transform: translateY(30px);
        margin-top: 0;
        animation: slide-in 250ms linear forwards;
        -webkit-animation: slide-in 250ms linear forwards;
      }

      .review {
        opacity: 0;
        -ms-transform: translateY(30px);
        -webkit-transform: translateY(30px);
        transform: translateY(30px);
        margin-top: 0;
        animation: slide-in 250ms linear forwards;
        -webkit-animation: slide-in 250ms linear forwards;
      }
    </style>

    <!-- Send review -->
    <iron-ajax id="SendReview" url="[[config.api.endpoint]]/ticket/add" method="POST" content-type="application/json" handle-as="json"
      on-response="_handleResponse" on-error="_handleError"></iron-ajax>
    <!-- End - Send review  -->


    <div class="wrapper">
      <!-- Summary -->
      <header class="flex flex-v-center flex-h-space-between">
        <div class="summary-rating flex flex-v-center">
          [[summaryRating]]
          <div class="summary-rating-stars flex flex-v-center">
            <template is="dom-repeat" items="[[_stars]]">
              <byprice-rating-star fill="[[item.filled]]"></byprice-rating-star>
            </template>
          </div>
        </div>
        <div class="summary-reviews">
          [[summaryReviews]] Reseñas
        </div>
        <template is="dom-if" if="[[summaryStories]]">
          <div class="summary-stories">[[summaryStories]] Historias</div>
        </template>
      </header>
      <!-- End - Summary -->

      <!-- Reviews -->
      <div class="reviews">
        <template is="dom-repeat" items="[[reviews]]">
          <div class="review">
            <byprice-review-message user-image="[[item.userImage]]" user-name="[[item.userName]]" date="[[item.date]]" message="[[item.message]]"
              has-stories="[[item.hasStories]]" rating="[[item.rating]]" likes="[[item.likes]]" dislikes="[[item.dislikes]]"></byprice-review-message>
          </div>
        </template>
      </div>
      <!-- End - reviews -->

      <div class="view-all">
        <span>Ver todas las reseñas</span>
      </div>

      <div class="forms-wrapper">
        <template is="dom-if" if="[[loader]]">
          <div class="loader-over"></div>
          <div class="loader"></div>
        </template>

        <!--Write a review -->
        <template is="dom-if" if="[[_invert(showPreview)]]">
          <div class="write-a-review">
             <byprice-write-a-review rating="{{rating}}" user="[[user]]" token="[[token]]" on-submit-review="_onSubmitReview" message="{{message}}"></byprice-write-a-review>
          </div>
        </template>
        <!--End - Write a review -->

        <!-- Check sign-->
        <template is="dom-if" if="[[showPreview]]">
          <div class="preview">
            <byprice-reviews-sign-preview id="Preview" rating="{{rating}}" message="[[message]]" show-preview="{{showPreview}}" on-submit-sign="_onSubmitSign"></byprice-reviews-sign-preview>
          </div>
        </template>
        <!-- End - Check sign-->

      </div>
    </div>

  </template>

  <script>
    /**
     * Class for byprice custom <byprice-reviews-widget></<byprice-reviews-widget>
     */
    class ByPriceReviewsWidget extends Polymer.Element {
      /**
       * Returns component name
       */
      static get is() {
        return 'byprice-reviews-widget';
      }

      /**
       * Declare properties for the element's public API
       */
      static get properties() {
        return {
          accountId: {
            type: String
          },
          loader: {
            type: Boolean,
            value: false
          },
          user: {
            type: Object,
            value: {
              image: 'https://78.media.tumblr.com/cd40ca1036fee9f42e4ab29360e976ce/tumblr_of2e9reEoX1v1hujco1_500.jpg',
              name: 'Eloiza Martinez',
              // token: 'asdf'
              // email: 'eloz@gmail.com',
            }
          },
          token: {
            type: String
          },
          item: {
            type: Object,
            value: {
              name: 'Redustat',
              image: 'https://media.byprice.com/1815c939-5429-4c81-bfce-d86599b270ee/byprice/1815c939-5429-4c81-bfce-d86599b270ee_300_300.png',
            }
          },
          channel: {
            type: String
          },
          summaryRating: {
            type: Number,
            value: 4.4
          },
          summaryReviews: {
            type: Number,
            value: 58
          },
          summaryStories: {
            type: Number,
            value: 0
          },
          rating: {
            type: Number,
            notify: true,
            value: 0
          },
          showPreview: {
            type: Boolean,
            value: false
          },
          reviews: {
            type: Array,
            value: [{
              userImage: 'https://78.media.tumblr.com/cd40ca1036fee9f42e4ab29360e976ce/tumblr_of2e9reEoX1v1hujco1_500.jpg',
              userName: 'Eloiza Martinez',
              date: 'Ayer',
              message: 'Increible producto, bajé 7.3 kg combinándolo con ejercicio y dieta muy bueno, nunca había bajado tanto, recomendadísimo!!',
              rating: 5,
              likes: 68,
              dislikes: 1,
            }, {
              // userImage: 'https://78.media.tumblr.com/1451651d3187488069e901c29d10a437/tumblr_no4qspM1u71t9762so1_500.jpg',
              userName: 'Maritza Lçopez',
              date: 'Jueves',
              message: 'Increible producto, bajé 7.3 kg combinándolo con ejercicio y dieta muy bueno, nunca había bajado tanto, recomendadísimo!!',
              rating: 3,
              likes: 6,
              dislikes: 12,
            }],
          },
          /* Private */
          _stars:  {
            type: Array,
            value: [{
              filled: true
            }, {
              filled: true
            }, {}, {}, {}]
          }
        }
      }

      /**
       * Legacy callback Called after property values are set and local DOM is initialized.
       */
      ready() {
        super.ready();
      }

      _onSubmitReview(e, details) {
        if (this.loader) return;
        var error = 0
        this.set('send', details);
        if (!this.user || !this.token) {
          this.set('showPreview', true);
        } else {
          this._sendReview(details);
        }
      }

      _sendReview(data) {
        this._success();
        this.$.SendReview.body = {}
        this.$.SendReview.generateRequest();
      }

      _onSubmitSign(e, details) {
        this._sendReview(this.details);
      }

      _success() {
        this.resetState();
        this.push('reviews', {
          userImage: this.user.image,
          userName: this.user.name,
          date: 'Hace unos segundos',
          message: this.send.message,
          rating: this.send.rating,
          likes: 0,
          dislikes: 0
        });
      }

      resetState() {
        this.set('showPreview', false);
        this.set('rating', 0);
        this.set('message', '');
        var $Preview = this.shadowRoot.getElementById('Preview')
        if ($Preview) $Preview.reset();
      }

      /**
       * Converts value to Boolean and inverts it
       * @param {*} value
       * @return {Boolean}
       */
      _invert(value) {
        return !Boolean(value);
      }

    }

    window.customElements.define(ByPriceReviewsWidget.is, ByPriceReviewsWidget);
  </script>
</dom-module>